
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <title>dyld_shared_cache · iOS逆向开发：iOS底层机制</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="HonKit 6.0.0">
        <meta name="author" content="Crifan Li <admin@crifan.com>">
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-anchors/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-expandable-menu/expandable-chapters.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/honkit-plugin-prism/prism-atom-dark.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-splitter-nosessionbutcookie/splitter.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-tbfed-pagefooter/footer.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-donate/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/honkit-plugin-blockquote-callout/style.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-theme-comscore/test.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../../appendix/" />
    
    
    <link rel="prev" href="./" />
    

    <style>
    @media only screen and (max-width: 640px) {
        .book-header .hidden-mobile {
            display: none;
        }
    }
    </style>
    <script>
        window["gitbook-plugin-github-buttons"] = {"buttons":[{"repo":"ios_re_ios_internal","user":"crifan","type":"star","count":true,"size":"small"},{"user":"crifan","type":"follow","width":"120","count":false,"size":"small"}]};
    </script>

    </head>
    <body>
        
<div class="book honkit-cloak">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    
    
        
        <li>
            <a href="http://www.crifan.org" target="_blank" class="custom-link">主页</a>
        </li>
    
    

    
    <li class="divider"></li>
    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                        <b>1.1.</b>
                    
                    前言
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../../ios_internal_overview/">
            
                <a href="../../ios_internal_overview/">
            
                    
                        <b>1.2.</b>
                    
                    iOS底层机制概览
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../../apple_dev_res/">
            
                <a href="../../apple_dev_res/">
            
                    
                        <b>1.3.</b>
                    
                    Apple开发资料
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../../apple_dev_res/ios_re_used.html">
            
                <a href="../../apple_dev_res/ios_re_used.html">
            
                    
                        <b>1.3.1.</b>
                    
                    iOS逆向常涉及内容
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../../common_logic/">
            
                <a href="../../common_logic/">
            
                    
                        <b>1.4.</b>
                    
                    通用逻辑
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../../common_logic/prologue_epilogue.html">
            
                <a href="../../common_logic/prologue_epilogue.html">
            
                    
                        <b>1.4.1.</b>
                    
                    Prologue和Epilogue
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../">
            
                <a href="../">
            
                    
                        <b>1.5.</b>
                    
                    iOS内核和底层机制
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../mach_o/">
            
                <a href="../mach_o/">
            
                    
                        <b>1.5.1.</b>
                    
                    Mach-O
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../XNU/">
            
                <a href="../XNU/">
            
                    
                        <b>1.5.2.</b>
                    
                    XNU
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="./">
            
                <a href="./">
            
                    
                        <b>1.5.3.</b>
                    
                    Frameworks框架
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="1.5.3.1" data-path="dyld_shared_cache.html">
            
                <a href="dyld_shared_cache.html">
            
                    
                        <b>1.5.3.1.</b>
                    
                    dyld_shared_cache
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../../appendix/">
            
                <a href="../../appendix/">
            
                    
                        <b>1.6.</b>
                    
                    附录
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../../appendix/reference.html">
            
                <a href="../../appendix/reference.html">
            
                    
                        <b>1.6.1.</b>
                    
                    参考资料
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://github.com/honkit/honkit" target="blank" class="gitbook-link">
            本书使用 HonKit 发布
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >dyld_shared_cache</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <html><head></head><body><h1 id="dyldsharedcache"><a name="dyldsharedcache" class="plugin-anchor" href="#dyldsharedcache"><i class="fa fa-link" aria-hidden="true"></i></a>dyld_shared_cache</h1>
<ul>
<li>dyld的shared cache = dyld (shared) cache<ul>
<li>概述：所有Framework库都被合并到共享缓存shared cache中了</li>
<li>位置：<ul>
<li><code>/System/Library/Caches/com.apple.dyld/</code><ul>
<li><code>/System/Library/Caches/com.apple.dyld/dyld_shared_cache_armX</code><ul>
<li><code>X</code>= <code>6</code>, <code>7</code>, <code>7s</code>, <code>64</code><ul>
<li>举例<ul>
<li><code>/System/Library/Caches/com.apple.dyld/dyld_shared_cache_arm64</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><code>/System/Library/dyld/dyld_shared_cache_arm64e</code></li>
</ul>
</li>
<li>详解<ul>
<li>从<code>iPhone OS 3.1</code>之后，所有系统（私有的private和公开的public）的库，都被合并到一个大的缓存文件了，目的是提升性能<ul>
<li>原始的单个的库文件，就多余了，所以被去掉了<ul>
<li>-》直接访问原始的单个系统库文件，就会出找不到的现象<ul>
<li>所以去从之前的，保存单个系统库的位置<ul>
<li>public=公开的库<ul>
<li><code>/System/Library/Frameworks</code></li>
</ul>
</li>
<li>private=私有的库<ul>
<li><code>/System/Library/PrivateFrameworks</code></li>
</ul>
</li>
</ul>
</li>
<li>就找不到库了</li>
</ul>
</li>
<li>举例<ul>
<li>iOS 13.5<ul>
<li>二进制程序代码 <ul>
<li>位置<ul>
<li><code>/Applications</code></li>
<li><code>/private/var/staged_system_apps</code></li>
</ul>
</li>
<li>是<code>shims</code>的 -&gt; <code>class-dump</code>：会报错，找不到<code>ObjC section</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>其他介绍<ul>
<li><a href="https://www.theiphonewiki.com/wiki//System/Library/Frameworks" target="_blank">/System/Library/Frameworks - The iPhone Wiki</a><ul>
<li><code>/System/Library/Frameworks</code><ul>
<li>A framework is a dynamic library and resources for that library, such as images and localization strings. Frameworks have the file extension .framework.</li>
<li>In iOS there are two kinds of frameworks: public frameworks and private frameworks. Public frameworks are allowed to be used in App Store apps. Private frameworks are intended to be used only by Apple's apps, and are more unstable against firmware changes, but many of the interesting features are in the private frameworks.</li>
<li>Since iOS 3.1, all default (private and public) libraries have been combined into a big cache file in <code>/System/Library/Caches/com.apple.dyld/dyld_shared_cache_armX</code> to improve performance. See dyld_shared_cache for more details. The original libraries are no longer useful for non-on-device-developers, so they are eliminated from the system. The framework folders still contain other resources, such as localization strings.</li>
</ul>
</li>
<li>Private Frameworks<ul>
<li>See <code>/System/Library/PrivateFrameworks</code>.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>源码<ul>
<li>github.com<ul>
<li><a href="https://github.com/opensource-apple/dyld/tree/master/launch-cache" target="_blank">https://github.com/opensource-apple/dyld/tree/master/launch-cache</a><ul>
<li><a href="https://github.com/opensource-apple/dyld/blob/master/launch-cache/dyld_shared_cache_util.cpp" target="_blank">https://github.com/opensource-apple/dyld/blob/master/launch-cache/dyld_shared_cache_util.cpp</a></li>
<li><a href="https://github.com/opensource-apple/dyld/blob/master/launch-cache/dsc_extractor.cpp" target="_blank">https://github.com/opensource-apple/dyld/blob/master/launch-cache/dsc_extractor.cpp</a></li>
<li><a href="https://github.com/opensource-apple/dyld/blob/master/launch-cache/dsc_iterator.cpp" target="_blank">https://github.com/opensource-apple/dyld/blob/master/launch-cache/dsc_iterator.cpp</a></li>
</ul>
</li>
</ul>
</li>
<li>opensource.apple.com<ul>
<li><a href="https://opensource.apple.com/source/dyld/dyld-852.2/dyld3/shared-cache/" target="_blank">https://opensource.apple.com/source/dyld/dyld-852.2/dyld3/shared-cache/</a><ul>
<li><a href="https://opensource.apple.com/source/dyld/dyld-852.2/dyld3/shared-cache/dyld_shared_cache_util.cpp.auto.html" target="_blank">https://opensource.apple.com/source/dyld/dyld-852.2/dyld3/shared-cache/dyld_shared_cache_util.cpp.auto.html</a></li>
<li><a href="https://opensource.apple.com/source/dyld/dyld-852.2/dyld3/shared-cache/dsc_extractor.cpp.auto.html" target="_blank">https://opensource.apple.com/source/dyld/dyld-852.2/dyld3/shared-cache/dsc_extractor.cpp.auto.html</a></li>
<li><a href="https://opensource.apple.com/source/dyld/dyld-852.2/dyld3/shared-cache/dsc_iterator.cpp.auto.html" target="_blank">https://opensource.apple.com/source/dyld/dyld-852.2/dyld3/shared-cache/dsc_iterator.cpp.auto.html</a></li>
<li><a href="https://opensource.apple.com/source/dyld/dyld-852.2/dyld3/shared-cache/dyldinfo.cpp.auto.html" target="_blank">https://opensource.apple.com/source/dyld/dyld-852.2/dyld3/shared-cache/dyldinfo.cpp.auto.html</a></li>
<li><a href="https://opensource.apple.com/source/dyld/dyld-852.2/dyld3/shared-cache/DyldSharedCache.cpp.auto.html" target="_blank">https://opensource.apple.com/source/dyld/dyld-852.2/dyld3/shared-cache/DyldSharedCache.cpp.auto.html</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="系统相关工具"><a name="系统相关工具" class="plugin-anchor" href="#系统相关工具"><i class="fa fa-link" aria-hidden="true"></i></a>系统相关工具</h2>
<h3 id="updatedyldsharedcache"><a name="updatedyldsharedcache" class="plugin-anchor" href="#updatedyldsharedcache"><i class="fa fa-link" aria-hidden="true"></i></a>update_dyld_shared_cache</h3>
<h4 id="man-page"><a name="man-page" class="plugin-anchor" href="#man-page"><i class="fa fa-link" aria-hidden="true"></i></a>man page</h4>
<pre class="language-"><code class="lang-bash">update_dyld_shared_cache<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>                    BSD General Commands Manual                    update_dyld_shared_cache<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

NAME

     update_dyld_shared_cache -- Updates dyld<span class="token string">'s shared cache

SYNOPSIS

     update_dyld_shared_cache [-root directory] [-overlay directory] [-arch arch] [-force] [-debug] [-sort_by_name] [-universal_boot] [-verify]
                  [-dylib_list file] [-iPhone] [-cache_dir dir]

DESCRIPTION

     update_dyld_shared_cache ensures that dyld'</span>s shared cache is up-to-date.  This tool is normally only run by Apple<span class="token string">'s Installer and Software
     Update, as they are the only official ways for OS dylibs to be updated.  But if for some reason you used another mechanism to alter an OS
     dylib, you should manually run update_dyld_shared_cache.

     Note that the new cache does not take effect until the OS is rebooted.

     If a safe-boot is done (booting with shift key held down) the cache is deleted.

     The dyld shared cache is mapped by dyld into a process at launch time. Later, when loading any mach-o image, dyld will first check if is in
     the share cache, and if it is will use that pre-bound version instead of opening, mapping, and binding the original file.    This results in
     significant performance improvements to launch time.

     update_dyld_shared_cache scans the directory /var/db/dyld/shared_region_roots for text files containing paths to mach-o executables.  The
     full dependencies of all dylibs required by those executables is used to determine which libraries are commonly used and should be placed in
     the shared cache. If one of the text files contains a path to a dylib, that dylib and its dependents will be forced into the cache.

     update_dyld_shared_cache builds a separate cache file for each architecture.  The cache files and a readable text map of the cached are gen-
     erated to /var/db/dyld.

     You must be root to run this tool.

     The options are as follows:

     -root directory
         This option specifies the root of an OS installation for which dyld'</span>s shared cache should be updated.    This is used by the In-
         staller to update the dyld shared cache <span class="token keyword">in</span> a partition other than the one you into <span class="token function">which</span> you are currently booted.  The cache
         files are created <span class="token keyword">in</span> the var/db/dyld directory of the specified directory.  Note: <span class="token keyword">if</span> you are manually doing this, be sure to run
         the update_dyld_shared_cache tool that is <span class="token keyword">in</span> the partition being updated.  This assures the cache <span class="token function">format</span> created will match that
         expected when booting off that partition.

     <span class="token parameter variable">-overlay</span> directory
         This option specifies the root of a sparse directory tree.  When building the dyld shared cache, any corresponding mach-o files
         <span class="token keyword">in</span> the sparse directory will override those <span class="token keyword">in</span> the boot partition.  This is used by Software Update to build a dyld shared cache
         <span class="token keyword">for</span> the update that is about to be installed.    The cache files are created <span class="token keyword">in</span> the var/db/dyld directory of the specified direc-
         tory.

     <span class="token parameter variable">-arch</span> arch  By default update_dyld_shared_cache generates cache files <span class="token keyword">for</span> all architecture that the current machine can execute.  You can
         override this behavior by specifying one or <span class="token function">more</span> <span class="token parameter variable">-arch</span> options and list exactly <span class="token function">which</span> architectures should have their shared
         caches updated.

     <span class="token parameter variable">-force</span>     This option will cause update_dyld_shared_cache to regenerated the shared cache files even <span class="token keyword">if</span> they appear to be already up-to-
         date.

     <span class="token parameter variable">-debug</span>     This option prints out additional information about the work being done.

     <span class="token parameter variable">-sort_by_name</span>
         By default update_dyld_shared_cache assigns a random start address to each mach-o image <span class="token keyword">in</span> the cache.    This option causes the
         start addresses to be chosen <span class="token keyword">in</span> path order, thus subsequent runs will produce the same address layout <span class="token function">which</span> can <span class="token builtin class-name">help</span> reproduce
         some bugs.

     <span class="token parameter variable">-universal_boot</span>
         This option can only be used running on an machine with an Intel processor.  It builds caches that can be used when booting on
         both <span class="token number">32</span>-bit and <span class="token number">64</span>-bit machines.

     <span class="token parameter variable">-dylib_list</span> <span class="token function">file</span>
         Instead of scanning /var/db/dyld/shared_region_roots/, this option provides a <span class="token function">file</span> that contains a list of the dylibs to use when
         building the shared cache file.

     <span class="token parameter variable">-verify</span>     Will regenerate a shared cache in-memory that matches the randomization of the existing shared cache file.  Then instead of writ-
         ing the cache file, it compares the in-memory cache <span class="token function">file</span> to the on disk version and reports any differences.

     <span class="token parameter variable">-iPhone</span>     indicates that cache is not <span class="token keyword">for</span> the current Mac OS X, but <span class="token keyword">for</span> rather <span class="token keyword">for</span> an iPhone

     <span class="token parameter variable">-cache_dir</span> directory
         This option specifies the directory <span class="token keyword">in</span> <span class="token function">which</span> to create the cache file<span class="token punctuation">(</span>s<span class="token punctuation">)</span>.  If not specified, the cache file<span class="token punctuation">(</span>s<span class="token punctuation">)</span> are created <span class="token keyword">in</span> the
         standard location <span class="token punctuation">(</span>e.g. var/db/dyld/<span class="token punctuation">)</span> of the root partition.

FILES

     /var/db/dyld/shared_region_roots directory of text files with paths to mach-o images used to determine what should be <span class="token keyword">in</span> shared cache.

SEE ALSO

     dyld<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

Darwin                                   Oct <span class="token number">10</span>, <span class="token number">2008</span>                                 Darwin
</code></pre>
<h2 id="逆向提取工具"><a name="逆向提取工具" class="plugin-anchor" href="#逆向提取工具"><i class="fa fa-link" aria-hidden="true"></i></a>逆向提取工具</h2>
<ul>
<li><code>dyld_decache</code><ul>
<li>代码<ul>
<li><a href="https://github.com/kennytm/Miscellaneous/blob/master/dyld_decache.cpp" target="_blank">https://github.com/kennytm/Miscellaneous/blob/master/dyld_decache.cpp</a></li>
</ul>
</li>
<li>相关<ul>
<li><a href="https://github.com/iosre/iOSAppReverseEngineering/blob/master/iOSAppReverseEngineering.pdf" target="_blank">https://github.com/iosre/iOSAppReverseEngineering/blob/master/iOSAppReverseEngineering.pdf</a></li>
</ul>
</li>
</ul>
</li>
<li>Dsc_extractor<ul>
<li>介绍<ul>
<li>is Apple’s own open-source tool for extracting libraries and frameworks from dyld_shared_cache. When extracting data, the utility saves the locations and original names of all extracted objects.</li>
</ul>
</li>
<li>开源代码<ul>
<li><a href="https://opensource.apple.com/source/dyld/dyld-433.5/launch-cache/dsc_extractor.cpp.auto.html" target="_blank">dsc_extractor.cpp (apple.com)</a></li>
</ul>
</li>
</ul>
</li>
<li><code>dyld_cache_extract</code><ul>
<li>作用：可视化的工具，把dyld_shared_cache载入即可解析出来</li>
<li>Github<ul>
<li><a href="https://github.com/macmade/dyld_cache_extract" target="_blank">https://github.com/macmade/dyld_cache_extract</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="涉及到的地方"><a name="涉及到的地方" class="plugin-anchor" href="#涉及到的地方"><i class="fa fa-link" aria-hidden="true"></i></a>涉及到的地方</h2>
<h3 id="相关函数"><a name="相关函数" class="plugin-anchor" href="#相关函数"><i class="fa fa-link" aria-hidden="true"></i></a>相关函数</h3>
<p><a href="https://opensource.apple.com/source/dyld/dyld-852.2/include/mach-o/dyld_priv.h.auto.html" target="_blank">dyld_priv.h</a></p>
<pre class="language-"><code class="lang-c"><span class="token comment">// Returns if any OS dylib has overridden its copy in the shared cache</span>
<span class="token comment">//</span>
<span class="token comment">// Exists in iPhoneOS 3.1 and later </span>
<span class="token comment">// Exists in Mac OS X 10.10 and later</span>
<span class="token keyword">extern</span> bool <span class="token function">dyld_shared_cache_some_image_overridden</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Returns path used by dyld for standard dyld shared cache file for the current arch.</span>
<span class="token comment">//</span>
<span class="token comment">// Exists in Mac OS X 10.11 and later</span>
<span class="token keyword">extern</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">dyld_shared_cache_file_path</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">dyld_shared_cache_dylib_text_info</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint64_t</span>        version<span class="token punctuation">;</span>        <span class="token comment">// current version 2</span>
    <span class="token comment">// following fields all exist in version 1</span>
    <span class="token class-name">uint64_t</span>        loadAddressUnslid<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span>        textSegmentSize<span class="token punctuation">;</span> 
    <span class="token class-name">uuid_t</span>            dylibUuid<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>        path<span class="token punctuation">;</span>            <span class="token comment">// pointer invalid at end of iterations</span>
    <span class="token comment">// following fields all exist in version 2</span>
    <span class="token class-name">uint64_t</span>        textSegmentOffset<span class="token punctuation">;</span>  <span class="token comment">// offset from start of cache</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">dyld_shared_cache_dylib_text_info</span> dyld_shared_cache_dylib_text_info<span class="token punctuation">;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__BLOCKS__</span></span>
<span class="token comment">// Given the UUID of a dyld shared cache file, this function will attempt to locate the cache</span>
<span class="token comment">// file and if found iterate all images, returning info about each one.  Returns 0 on success.</span>
<span class="token comment">//</span>
<span class="token comment">// Exists in Mac OS X 10.11 and later</span>
<span class="token comment">//           iOS 9.0 and later</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">dyld_shared_cache_iterate_text</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">uuid_t</span> cacheUuid<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">^</span>callback<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> dyld_shared_cache_dylib_text_info<span class="token operator">*</span> info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Given the UUID of a dyld shared cache file, and a NULL terminated array of extra directory paths to search,</span>
<span class="token comment">// this function will scan the standard and extra directories looking for a cache file that matches the UUID</span>
<span class="token comment">// and if found iterate all images, returning info about each one.  Returns 0 on success.</span>
<span class="token comment">//</span>
<span class="token comment">// Exists in Mac OS X 10.12 and later</span>
<span class="token comment">//           iOS 10.0 and later</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">dyld_shared_cache_find_iterate_text</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">uuid_t</span> cacheUuid<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> extraSearchDirs<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">^</span>callback<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> dyld_shared_cache_dylib_text_info<span class="token operator">*</span> info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __BLOCKS */</span></span>

<span class="token comment">// Gets the UUID of the dyld shared cache in the current process.</span>
<span class="token comment">// Returns false if there is no dyld shared cache in use by the processes.</span>
<span class="token comment">//</span>
<span class="token comment">// Exists in Mac OS X 10.12 and later</span>
<span class="token comment">// Exists in iOS 10.0 and later</span>
<span class="token keyword">extern</span> bool <span class="token function">_dyld_get_shared_cache_uuid</span><span class="token punctuation">(</span><span class="token class-name">uuid_t</span> uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Returns the start address of the dyld cache in the process and sets length to the size of the cache.</span>
<span class="token comment">// Returns NULL if the process is not using a dyld shared cache</span>
<span class="token comment">//</span>
<span class="token comment">// Exists in Mac OS X 10.13 and later</span>
<span class="token comment">// Exists in iOS 11.0 and later</span>
<span class="token keyword">extern</span> <span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">_dyld_get_shared_cache_range</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token operator">*</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Returns if the currently active dyld shared cache is optimized.</span>
<span class="token comment">// Note: macOS does not use optimized caches and will always return false.</span>
<span class="token comment">//</span>
<span class="token comment">// Exists in Mac OS X 10.15 and later</span>
<span class="token comment">// Exists in iOS 13.0 and later</span>
<span class="token keyword">extern</span> bool <span class="token function">_dyld_shared_cache_optimized</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Returns if the currently active dyld shared cache was built locally.</span>
<span class="token comment">//</span>
<span class="token comment">// Exists in Mac OS X 10.15 and later</span>
<span class="token comment">// Exists in iOS 13.0 and later</span>
<span class="token keyword">extern</span> bool <span class="token function">_dyld_shared_cache_is_locally_built</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// This is similar to _dyld_shared_cache_contains_path(), except that it returns the canonical</span>
<span class="token comment">// shared cache path for the given path.</span>
<span class="token comment">//</span>
<span class="token comment">// Exists in macOS 10.16 and later</span>
<span class="token comment">// Exists in iOS 14.0 and later</span>
<span class="token keyword">extern</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">_dyld_shared_cache_real_path</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="systemlibrarycachescomappledylddyldsharedcachearmx"><a name="systemlibrarycachescomappledylddyldsharedcachearmx" class="plugin-anchor" href="#systemlibrarycachescomappledylddyldsharedcachearmx"><i class="fa fa-link" aria-hidden="true"></i></a>/System/Library/Caches/com.apple.dyld/dyld_shared_cache_armX</h3>
<h4 id="iphone7"><a name="iphone7" class="plugin-anchor" href="#iphone7"><i class="fa fa-link" aria-hidden="true"></i></a>iPhone7</h4>
<pre class="language-"><code class="lang-bash">iPhone7:~ root<span class="token comment"># ls -lh /System/Library/Caches/com.apple.dyld</span>
total <span class="token number">1</span>.7G
-rwxr-xr-x <span class="token number">1</span> root admin <span class="token number">1</span>.7G Apr  <span class="token number">3</span>  <span class="token number">2020</span> dyld_shared_cache_arm64*
</code></pre>
<h4 id="iphone8"><a name="iphone8" class="plugin-anchor" href="#iphone8"><i class="fa fa-link" aria-hidden="true"></i></a>iPhone8</h4>
<pre class="language-"><code class="lang-bash">iPhone8-150:~ root<span class="token comment"># ls -lh /System/Library</span>
total <span class="token number">0</span>
<span class="token punctuation">..</span>.
drwxr-xr-x   <span class="token number">40</span> root wheel <span class="token number">1</span>.3K Sep <span class="token number">16</span>  <span class="token number">2021</span> CacheDelete/
drwxr-xr-x    <span class="token number">6</span> root wheel  <span class="token number">192</span> Sep <span class="token number">16</span>  <span class="token number">2021</span> Caches/
<span class="token punctuation">..</span>.
</code></pre>
<p>-&gt;</p>
<pre class="language-"><code class="lang-bash">iPhone8-150:~ root<span class="token comment"># ls -lh /System/Library/Caches</span>
total <span class="token number">0</span>
lrwxr-xr-x  <span class="token number">1</span> root wheel  <span class="token number">45</span> Sep <span class="token number">16</span>  <span class="token number">2021</span> apticket.der -<span class="token operator">&gt;</span> <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/usr/standalone/firmware/apticket.der
drwxr-xr-x  <span class="token number">9</span> root wheel <span class="token number">288</span> Sep <span class="token number">16</span>  <span class="token number">2021</span> com.apple.dyld/
drwxr-xr-x <span class="token number">21</span> root wheel <span class="token number">672</span> Nov <span class="token number">11</span>  <span class="token number">2014</span> com.apple.factorydata/
drwxr-xr-x  <span class="token number">2</span> root wheel  <span class="token number">64</span> Sep <span class="token number">16</span>  <span class="token number">2021</span> com.apple.kernelcaches/
</code></pre>
<p>-&gt;</p>
<pre class="language-"><code class="lang-bash">iPhone8-150:~ root<span class="token comment"># ls -lh /System/Library/Caches/com.apple.dyld</span>
total <span class="token number">2</span>.5G
-rwxr-xr-x <span class="token number">1</span> root admin 521M Sep <span class="token number">16</span>  <span class="token number">2021</span> dyld_shared_cache_arm64*
-rwxr-xr-x <span class="token number">1</span> root admin 513M Sep <span class="token number">16</span>  <span class="token number">2021</span> dyld_shared_cache_arm64.1*
-rwxr-xr-x <span class="token number">1</span> root admin 508M Sep <span class="token number">16</span>  <span class="token number">2021</span> dyld_shared_cache_arm64.2*
-rwxr-xr-x <span class="token number">1</span> root admin  83M Sep <span class="token number">16</span>  <span class="token number">2021</span> dyld_shared_cache_arm64.3*
-rwxr-xr-x <span class="token number">1</span> root admin 238M Sep <span class="token number">16</span>  <span class="token number">2021</span> dyld_shared_cache_arm64.4*
-rwxr-xr-x <span class="token number">1</span> root admin 199M Sep <span class="token number">16</span>  <span class="token number">2021</span> dyld_shared_cache_arm64.5*
-rwxr-xr-x <span class="token number">1</span> root admin 456M Sep <span class="token number">16</span>  <span class="token number">2021</span> dyld_shared_cache_arm64.symbols*
</code></pre>
<h3 id="systemlibrarydylddyldsharedcachearm64e"><a name="systemlibrarydylddyldsharedcachearm64e" class="plugin-anchor" href="#systemlibrarydylddyldsharedcachearm64e"><i class="fa fa-link" aria-hidden="true"></i></a>/System/Library/dyld/dyld_shared_cache_arm64e</h3>
<p><a href="https://www.apriorit.com/dev-blog/778-reverse-engineering-undocumented-macos-api" target="_blank">How to Reverse Engineer an Undocumented macOS API to Use It in a Swift Project | Apriorit</a></p>
<p>Step 1: Obtaining a method signature</p>
<p>The OSSystemExtensionClient API is part of the SystemExtensions framework. The framework is packaged as a dynamically linked shared library, which is part of the dynamically linked shared library cache available at /System/Library/dyld/dyld_shared_cache_arm64e.</p>
<h3 id="objc-runtime-newmm"><a name="objc-runtime-newmm" class="plugin-anchor" href="#objc-runtime-newmm"><i class="fa fa-link" aria-hidden="true"></i></a>objc-runtime-new.mm</h3>
<p><a href="https://opensource.apple.com/source/objc4/objc4-750/runtime/objc-runtime-new.mm.auto.html" target="_blank">objc-runtime-new.mm (apple.com)</a></p>
<pre class="language-"><code class="lang-c">objc_class<span class="token operator">::</span><span class="token function">demangledName</span><span class="token punctuation">(</span>bool realize<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// fixme lldb's calls to class_getName() can also get here when</span>
    <span class="token comment">// interrogating the dyld shared cache. (rdar://27258517)</span>
    <span class="token comment">// fixme runtimeLock.assertLocked();</span>
    <span class="token comment">// fixme assert(realize);</span>
</code></pre>
<h3 id="maskdylib"><a name="maskdylib" class="plugin-anchor" href="#maskdylib"><i class="fa fa-link" aria-hidden="true"></i></a>Mask.dylib</h3>
<pre class="language-"><code class="lang-bash">➜  DynamicLibraries rabin2 <span class="token parameter variable">-i</span> Mask.dylib <span class="token operator">&gt;</span> MaskDylib_rabin2_i_imports.txt
</code></pre>
<p>-&gt;</p>
<p><code>MaskDylib_rabin2_i_imports.coffee</code></p>
<pre class="language-"><code>50  0x0000e508 NONE FUNC           dyld_shared_cache_file_path
</code></pre><h3 id="ida"><a name="ida" class="plugin-anchor" href="#ida"><i class="fa fa-link" aria-hidden="true"></i></a>IDA</h3>
<p><a href="https://docs.hex-rays.com/user-guide/plugins/plugins-shipped-with-ida/dyld-shared-cache-utils" target="_blank">DYLD Shared Cache Utils | Hex-Rays Docs</a></p>
<p><a href="https://hex-rays.com/products/ida/news/7_2/the_mac_rundown/" target="_blank">IDA: IDA 7.2 - The Mac Rundown (hex-rays.com)</a></p>
<p>This is another annoyance of dyldcache analysis</p>
<h3 id="cutter"><a name="cutter" class="plugin-anchor" href="#cutter"><i class="fa fa-link" aria-hidden="true"></i></a>Cutter</h3>
<p><img src="../../assets/img/dyld_sharded_cache_cutter.png" alt="dyld_sharded_cache_cutter"></img></p>
<p>中有：<code>dyldcache</code></p>
<h3 id="jtool2"><a name="jtool2" class="plugin-anchor" href="#jtool2"><i class="fa fa-link" aria-hidden="true"></i></a>jtool2</h3>
<pre class="language-"><code class="lang-bash">➜  jtool2 jtool2 <span class="token parameter variable">--help</span>
<span class="token punctuation">..</span>.
   <span class="token parameter variable">-h</span>             Dump Mach-O <span class="token punctuation">(</span>or DYLD Shared Cache<span class="token punctuation">)</span> header
<span class="token punctuation">..</span>.
   <span class="token parameter variable">-e</span>             extract fat slice, Mach-O segment/section, dyld shared cache dylib or <span class="token punctuation">(</span>NEW<span class="token punctuation">)</span> kernelcache kext
<span class="token punctuation">..</span>.
dyldinfo Compatible Options:
   <span class="token parameter variable">--bind</span>             print addresses dyld will <span class="token builtin class-name">set</span> based on symbolic lookups
   <span class="token parameter variable">--lazy_bind</span>        print addresses dyld will lazily <span class="token builtin class-name">set</span> on first use
   <span class="token parameter variable">--opcodes</span>          print opcodes used to generate the rebase and binding information
   <span class="token parameter variable">--function_starts</span>    print table of <span class="token keyword">function</span> start addresses
<span class="token punctuation">..</span>.
   <span class="token parameter variable">--tbd</span>          Create a .tbd <span class="token function">file</span> <span class="token punctuation">(</span>for *OS private frameworks only - you'll need the dyld shared cache <span class="token keyword">for</span> this<span class="token punctuation">)</span>
</code></pre>
<footer class="page-footer"><span class="copyright">crifan.org，使用<a href="https://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank">署名4.0国际(CC BY 4.0)协议</a>发布 all right reserved，powered by Gitbook</span><span class="footer-modification">最后更新：
2024-10-15 10:33:48
</span></footer></body></html>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="./" class="navigation navigation-prev " aria-label="Previous page: Frameworks框架">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../../appendix/" class="navigation navigation-next " aria-label="Next page: 附录">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"dyld_shared_cache","level":"1.5.3.1","depth":3,"next":{"title":"附录","level":"1.6","depth":1,"path":"appendix/README.md","ref":"appendix/README.md","articles":[{"title":"参考资料","level":"1.6.1","depth":2,"path":"appendix/reference.md","ref":"appendix/reference.md","articles":[]}]},"previous":{"title":"Frameworks框架","level":"1.5.3","depth":2,"path":"ios_internal_logic/frameworks/README.md","ref":"ios_internal_logic/frameworks/README.md","articles":[{"title":"dyld_shared_cache","level":"1.5.3.1","depth":3,"path":"ios_internal_logic/frameworks/dyld_shared_cache.md","ref":"ios_internal_logic/frameworks/dyld_shared_cache.md","articles":[]}]},"dir":"ltr"},"config":{"plugins":["theme-comscore","anchors","expandable-menu","-lunr","-search","search-plus","disqus","-highlight","prism","prism-themes","github-buttons","-splitter","splitter-nosessionbutcookie","-sharing","sharing-plus","tbfed-pagefooter","donate","sitemap-general","copy-code-button","blockquote-callout","toolbar-button"],"root":"./src","styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"tbfed-pagefooter":{"copyright":"crifan.org，使用<a href='https://creativecommons.org/licenses/by/4.0/deed.zh'>署名4.0国际(CC BY 4.0)协议</a>发布","modify_label":"最后更新：","modify_format":"YYYY-MM-DD HH:mm:ss"},"prism":{"css":["prism-themes/themes/prism-atom-dark.css"]},"disqus":{"useIdentifier":false,"shortName":"crifan"},"toolbar-button":{"label":"下载PDF","url":"https://book.crifan.org/books/ios_re_ios_internal/pdf/ios_re_ios_internal.pdf","icon":"fa-file-pdf-o"},"sharing-plus":{"qq":false,"all":["facebook","google","twitter","instapaper","linkedin","pocket","stumbleupon"],"douban":false,"facebook":true,"weibo":false,"instapaper":false,"whatsapp":false,"hatenaBookmark":false,"twitter":true,"messenger":false,"line":false,"vk":false,"pocket":true,"google":false,"viber":false,"stumbleupon":false,"qzone":false,"linkedin":false},"donate":{"title":"","button":"打赏","wechat":"https://www.crifan.org/files/res/crifan_com/crifan_wechat_pay.jpg","alipay":"https://www.crifan.org/files/res/crifan_com/crifan_alipay_pay.jpg","wechatText":"微信打赏给Crifan","alipayText":"支付宝打赏给Crifan"},"sitemap-general":{"prefix":"https://book.crifan.org/books/ios_re_ios_internal/website/"},"fontsettings":{"theme":"white","family":"sans","size":2},"blockquote-callout":{},"theme-comscore":{},"splitter-nosessionbutcookie":{},"prism-themes":{},"github-buttons":{"buttons":[{"repo":"ios_re_ios_internal","user":"crifan","type":"star","count":true,"size":"small"},{"user":"crifan","type":"follow","width":"120","count":false,"size":"small"}]},"expandable-menu":{},"copy-code-button":{},"sharing":{"qq":true,"all":["douban","facebook","google","instapaper","line","linkedin","messenger","pocket","qq","qzone","stumbleupon","twitter","viber","vk","weibo","whatsapp"],"douban":false,"facebook":true,"weibo":true,"instapaper":false,"whatsapp":false,"hatenaBookmark":false,"twitter":true,"messenger":false,"line":false,"vk":false,"pocket":false,"google":false,"viber":false,"stumbleupon":false,"qzone":false,"linkedin":false},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":true},"anchors":{},"search-plus":{}},"theme":"default","author":"Crifan Li <admin@crifan.com>","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"embedFonts":false},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"iOS逆向开发：iOS底层机制","language":"zh-hans","links":{"sidebar":{"主页":"http://www.crifan.org"}},"gitbook":"*","description":"介绍iOS逆向开发期间涉及到iOS底层机制方面的，主要是ObjC方面的内容。包括Block回调、ObjC的Runtime运行时、Apple苹果相关开发资料。以及一些逆向的动态调试中涉及到iOS底层机制的相关心得。"},"file":{"path":"ios_internal_logic/frameworks/dyld_shared_cache.md","mtime":"2024-10-15T02:33:48.026Z","type":"markdown"},"gitbook":{"version":"6.0.0","time":"2024-10-15T02:35:16.737Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <noscript>
        <style>
            .honkit-cloak {
                display: block !important;
            }
        </style>
    </noscript>
    <script>
        // Restore sidebar state as critical path for prevent layout shift
        function __init__getSidebarState(defaultValue){
            var baseKey = "";
            var key = baseKey + ":sidebar";
            try {
                var value = localStorage[key];
                if (value === undefined) {
                    return defaultValue;
                }
                var parsed = JSON.parse(value);
                return parsed == null ? defaultValue : parsed;
            } catch (e) {
                return defaultValue;
            }
        }
        function __init__restoreLastSidebarState() {
            var isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                // Init last state if not mobile
                return;
            }
            var sidebarState = __init__getSidebarState(true);
            var book = document.querySelector(".book");
            // Show sidebar if it enabled
            if (sidebarState && book) {
                book.classList.add("without-animation", "with-summary");
            }
        }

        try {
            __init__restoreLastSidebarState();
        } finally {
            var book = document.querySelector(".book");
            book.classList.remove("honkit-cloak");
        }
    </script>
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-expandable-menu/expandable-chapters.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-github-buttons/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-splitter-nosessionbutcookie/splitter.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing-plus/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-donate/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-toolbar-button/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-theme-comscore/test.js"></script>
        
    

    </body>
</html>

